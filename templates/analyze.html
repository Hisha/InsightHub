{% extends "base.html" %}

{% block content %}
<h2>Analyze: {{ table_name }}</h2>

<form id="ask-form">
  <label for="question">Ask a question about this table:</label><br>
  <input type="text" id="question" name="question" size="60" required>
  <button type="submit">Ask</button>
</form>

<div id="loading" style="margin-top:1em;"></div>
<div id="answer" style="margin-top:2em;"></div>

{% if sql_query %}
  <h3>Generated SQL Query:</h3>
  <pre>{{ sql_query }}</pre>
{% endif %}

{% if result_html %}
  <h3>Query Result:</h3>
  {{ result_html|safe }}
{% endif %}

<pre id="table-preview" style="display:none;">
{{ table_preview }}
</pre>

<script>
document.getElementById("ask-form").addEventListener("submit", async function(event) {
  event.preventDefault();

  const question = document.getElementById("question").value.trim();
  const preview = document.getElementById("table-preview").innerText.trim();
  const loadingEl = document.getElementById("loading");
  const answerEl = document.getElementById("answer");

  if (!question) return;

  loadingEl.innerHTML = "‚è≥ Sending question to LLM...";
  answerEl.innerHTML = "";

  try {
    const askRes = await fetch(`/insight/analyze/{{ table_name }}/ask`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ question, preview })
    });

    const askData = await askRes.json();
    if (!askData.ok || !askData.job_id) {
      loadingEl.innerHTML = `<span style="color:red;">Error: Failed to queue job</span>`;
      return;
    }

    const jobId = askData.job_id;
    loadingEl.innerHTML = `üîÑ Waiting for LLM response (Job ID: ${jobId})...`;

    let attempts = 0;
    const maxAttempts = 60;
    const delayMs = 2000;

    while (attempts < maxAttempts) {
      await new Promise(resolve => setTimeout(resolve, delayMs));
      attempts++;

      const statusRes = await fetch(`/insight/analyze/status/${jobId}`);
      const statusData = await statusRes.json();

      if (statusData.done) {
        loadingEl.innerHTML = "";
        answerEl.innerHTML = `
          <h3>LLM Response:</h3>
          <pre>${statusData.output}</pre>
          <form action="/insight/run_query/{{ table_name }}" method="post">
            <input type="hidden" name="sql_query" value="${encodeURIComponent(statusData.output)}">
            <button type="submit">Run this SQL query</button>
          </form>
        `;
        return;
      }
    }

    loadingEl.innerHTML = `<span style="color:red;">Timeout: LLM did not respond in time.</span>`;
  } catch (err) {
    loadingEl.innerHTML = `<span style="color:red;">Error: ${err.message}</span>`;
  }
});
</script>
{% endblock %}

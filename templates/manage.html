{% extends "base.html" %}
{% block content %}
<h1>Manage Uploaded Tables</h1>
<table class="uploaded-tables">
  <thead>
    <tr>
      <th>Table Name</th>
      <th>Uploaded By</th>
      <th>Date</th>
      <th>Preview</th>
      <th>Delete</th>
      <th>Analyze</th>
    </tr>
  </thead>
  <tbody>
    {% for table in tables %}
    <tr>
      <td>{{ table.table_name }}</td>
      <td>{{ table.uploaded_by }}</td>
      <td>{{ table.uploaded_at.strftime('%Y-%m-%d %H:%M') }}</td>
      <td><button class="preview-btn" data-name="{{ table.table_name }}">+</button></td>
      <td><button class="delete-btn" data-name="{{ table.table_name }}">ğŸ—‘ï¸</button></td>
      <td><a href="/insight/analyze/{{ table.table_name }}" class="analyze-link">ğŸ”</a></td>
    </tr>
    <tr class="preview-row" id="preview-{{ table.table_name }}" style="display:none;">
      <td colspan="5"><div class="preview-content">Loading...</div></td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const previewButtons = document.querySelectorAll(".preview-btn");

  previewButtons.forEach(button => {
    button.addEventListener("click", async () => {
      const tableName = button.getAttribute("data-name");
      const previewRow = document.getElementById(`preview-${tableName}`);

      if (previewRow.style.display === "none") {
        previewRow.querySelector(".preview-content").innerHTML = "Loading...";
        previewRow.style.display = "table-row";

        const response = await fetch(`/insight/preview_table/${tableName}`);
        const html = await response.text();
        previewRow.querySelector(".preview-content").innerHTML = html;
      } else {
        previewRow.style.display = "none";
      }
    });
  });

  const deleteButtons = document.querySelectorAll(".delete-btn");

  deleteButtons.forEach(button => {
    button.addEventListener("click", async () => {
      const tableName = button.getAttribute("data-name");
      if (confirm(`Are you sure you want to delete table "${tableName}"?`)) {
        const response = await fetch(`/insight/delete_table/${tableName}`, { method: "DELETE" });
        if (response.ok) {
          button.closest("tr").nextElementSibling.remove(); // remove preview row
          button.closest("tr").remove(); // remove main row
        } else {
          alert("Delete failed.");
        }
      }
    });
  });
});
</script>


{% endblock %}

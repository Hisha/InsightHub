{% extends "base.html" %}
{% block content %}
<h1>Manage Uploaded Tables</h1>
<table class="uploaded-tables">
  <thead>
    <tr>
      <th>Table Name</th>
      <th>Uploaded By</th>
      <th>Date</th>
      <th>Preview</th>
      <th>Delete</th>
    </tr>
  </thead>
  <tbody>
    {% for table in tables %}
    <tr>
      <td>{{ table.table_name }}</td>
      <td>{{ table.uploaded_by }}</td>
      <td>{{ table.uploaded_at.strftime('%Y-%m-%d %H:%M') }}</td>
      <td><button class="preview-btn" data-name="{{ table.table_name }}">+</button></td>
      <td><button class="delete-btn" data-name="{{ table.table_name }}">üóëÔ∏è</button></td>
    </tr>
    <tr class="preview-row" id="preview-{{ table.table_name }}" style="display:none;">
      <td colspan="5"><div class="preview-content">Loading...</div></td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const buttons = document.querySelectorAll(".expand-btn");

  buttons.forEach((btn) => {
    btn.addEventListener("click", async () => {
      const row = btn.closest("tr");
      const tableName = row.getAttribute("data-table");
      const alreadyExpanded = row.nextElementSibling?.classList.contains("preview-row");

      if (alreadyExpanded) {
        row.nextElementSibling.remove();
        return;
      }

      const response = await fetch(`/insight/preview_table?name=${tableName}`);
      const data = await response.text();

      const previewRow = document.createElement("tr");
      previewRow.classList.add("preview-row");
      previewRow.innerHTML = `<td colspan="4" class="manage-preview">${data}</td>`;
      row.parentNode.insertBefore(previewRow, row.nextSibling);
    });
  });
});
</script>

{% endblock %}
